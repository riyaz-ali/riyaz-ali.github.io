<!doctype html><html lang=en><head><title>Android Support Paging Library :: Riyaz Ali</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Recently, I was working on a project for the Udacity Android Nanodegree program to develop an Android application for TMDb to list movies using the TMDb API.
As you might&amp;rsquo;ve guessed, TMDb has a huge collection of movies, and so a need for paging the data was quite obvious from the very begining of the project.
So I started looking into ways in which I could&amp;rsquo;ve implemented paging with my RecyclerView."><meta name=keywords content="Android,Android Support Library,Android Pagination"><meta name=robots content="noodp"><link rel=canonical href=https://riyazali.net/posts/android-support-paging-library/><link rel=stylesheet href=https://riyazali.net/assets/style.css><link rel=stylesheet href=https://riyazali.net/assets/blue.css><link rel=stylesheet href=https://riyazali.net/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://riyazali.net/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://riyazali.net/icons/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:creator content="riyaz-ali"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Android Support Paging Library :: Riyaz Ali"><meta property="og:description" content="In this how-to, I've tried to explain how you can use
Android Support Paging Library to improve your app's 
performance while loading dynamic data.
"><meta property="og:url" content="https://riyazali.net/posts/android-support-paging-library/"><meta property="og:site_name" content="Android Support Paging Library"><meta property="og:image" content="https://riyazali.net/icons/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2018-06-01 00:00:00 +0000 UTC"><script data-goatcounter=https://goat.riyazali.net/count async src=https://goat.riyazali.net/count.js></script></head><body><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Riyaz Ali</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/resume.pdf>Resume</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/resume.pdf>Resume</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://riyazali.net/posts/android-support-paging-library/>Android Support Paging Library</a></h1><div class=post-meta><span class=post-date>2018-06-01</span>
<span class=post-author>::
riyaz-ali</span></div><span class=post-tags>#<a href=https://riyazali.net/tags/android/>Android</a>&nbsp;
#<a href=https://riyazali.net/tags/androidsupportlibrary/>AndroidSupportLibrary</a>&nbsp;
#<a href=https://riyazali.net/tags/howto/>HowTo</a>&nbsp;</span><div class=post-content><div><p>Recently, I was working on a project for the <a href=https://in.udacity.com/course/android-developer-nanodegree-by-google--nd801>Udacity Android Nanodegree program</a> to develop an Android application for <a href=https://www.themoviedb.org/><strong>TMDb</strong></a> to list movies using the <a href=https://developers.themoviedb.org/3/getting-started/introduction>TMDb API</a>.</p><p>As you might&rsquo;ve guessed, TMDb has a <em>huge collection of movies</em>, and so a need for <em>paging the data</em> was quite obvious from the very begining of the project.</p><p>So I started looking into ways in which I could&rsquo;ve implemented paging with my <code>RecyclerView</code>. Turns out there are a few ways to achieve this!</p><ol><li><p><em>The old way</em> (as documented in <a href=https://github.com/codepath/android_guides/wiki/Endless-Scrolling-with-AdapterViews-and-RecyclerView>this CodePath guide</a>) is to use <a href=https://developer.android.com/reference/android/support/v7/widget/RecyclerView.OnScrollListener><code>RecyclerView.OnScrollListener</code></a> and <em>listen for</em> scroll events and load data accordingly! But with the release of the <a href=https://developer.android.com/topic/libraries/architecture/paging>Android Paging Library</a>, the guide is now considered <em>deprecated</em>!</p></li><li><p><em>The new way</em> (yeah! you guessed it) is to use <a href=https://developer.android.com/topic/libraries/architecture/paging>Android Paging Library</a> and the rest of this post is all about how to integrate it!</p></li></ol><h3 id=architecture>Architecture<a href=#architecture class=hanchor arialabel=Anchor>&#8983;</a></h3><p>So you ask, how this Paging Library works?</p><p>Well, there are four major components in the Paging Library:</p><ol><li><p><code>DataSource</code>: The <code>DataSource</code> is where you write code to interact with your source (REST API, sqlite database, etc.) All the requests for data from the <code>DataSource</code> are made on a background thread and so you can safely write <em>synchronous</em> code to interact with your source, if you want to. <code>DataSource</code> is responsible to load a <code>List&lt;T></code> of your model object given a page/key and implement business logic for the same.</p></li><li><p><code>PagedListAdapter&lt;T, VH></code>: <code>PagedListAdapter</code> is a <code>RecyclerView.Adapter</code> which uses a <code>PagedList</code> (see below) to load data into the UI. <code>PagedListAdapter</code> uses a <code>DiffUtils.ItemCallback&lt;T></code> implementation to calculate <em>difference</em> between your model objects in the list and animates add/remove operations on UI.</p></li><li><p><code>DiffUtils.ItemCallback&lt;T></code>: The <code>DiffUtils.ItemCallback&lt;T></code> for your model class is utilized by the <code>PagedListAdapter</code> to calculate <em>diff</em> between two list and animate changes in the UI. You must provide an implementation of this callback. The callback is executed on a background thread to prevent stalling the UI.</p></li><li><p><code>PagedList&lt;T></code>: A <code>PagedList</code> is a Java-collection which loads it&rsquo;s data in chunks (pages) from a <code>DataSource</code>. The <code>PagedList</code> connects your <code>PagedListAdapter</code> and your <code>DataSource</code> together and is responsible to <em>lazy load</em> data by calling appropriate methods on the <code>DataSource</code>.</p></li></ol><img src=https://cdn-images-1.medium.com/max/800/1*O1acN3yAOS70zbRMfThXrw.gif alt="Paging Library Architecture" class=center><p>First, we create a <em>model POJO</em> class (referred in the post as <code>Movie</code>) and implement <a href=https://developer.android.com/reference/android/support/v7/util/DiffUtil.ItemCallback><code>DiffUtil.ItemCallback&lt;T></code></a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Movie</span> <span style=color:#f92672>{</span>
  <span style=color:#75715e>// id of the movie
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> id<span style=color:#f92672>;</span>
  <span style=color:#75715e>// title of the movie
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> String title<span style=color:#f92672>;</span>
  <span style=color:#75715e>// path to movie&#39;s poster
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> String poster<span style=color:#f92672>;</span>

  <span style=color:#75715e>// DiffCallback to assist Adapter
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> DiffUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>ItemCallback</span><span style=color:#f92672>&lt;</span>Movie<span style=color:#f92672>&gt;</span> DIFF_CALLBACK <span style=color:#f92672>=</span> 
    <span style=color:#66d9ef>new</span> DiffUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>ItemCallback</span><span style=color:#f92672>&lt;</span>Movie<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
      <span style=color:#a6e22e>@Override</span> 
      <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>areItemsTheSame</span><span style=color:#f92672>(</span>Movie oldItem<span style=color:#f92672>,</span> Movie newItem<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> oldItem<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span> <span style=color:#f92672>==</span> newItem<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>;</span>
      <span style=color:#f92672>}</span>

      <span style=color:#a6e22e>@Override</span>
      <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>areContentsTheSame</span><span style=color:#f92672>(</span>Movie oldItem<span style=color:#f92672>,</span> Movie newItem<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> TextUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>oldItem<span style=color:#f92672>.</span><span style=color:#a6e22e>poster</span><span style=color:#f92672>,</span> newItem<span style=color:#f92672>.</span><span style=color:#a6e22e>poster</span><span style=color:#f92672>)</span>
            <span style=color:#f92672>&amp;&amp;</span> TextUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>oldItem<span style=color:#f92672>.</span><span style=color:#a6e22e>title</span><span style=color:#f92672>,</span> newItem<span style=color:#f92672>.</span><span style=color:#a6e22e>title</span><span style=color:#f92672>);</span>
      <span style=color:#f92672>}</span>
    <span style=color:#f92672>};</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Then, we subclass <a href=https://developer.android.com/reference/android/arch/paging/PagedListAdapter>PagedListAdapter</a> and create our custom <a href=https://developer.android.com/reference/android/support/v7/widget/RecyclerView.Adapter>adapter</a> which will be used to display <code>Movie</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// required imports
</span><span style=color:#75715e></span><span style=color:#f92672>import</span> android.arch.paging.PagedListAdapter<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MovieAdapter</span> 
  <span style=color:#66d9ef>extends</span> PagedListAdapter<span style=color:#f92672>&lt;</span>Movie<span style=color:#f92672>,</span> MovieAdapter<span style=color:#f92672>.</span><span style=color:#a6e22e>ViewHolder</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
  <span style=color:#75715e>// ViewHolder removed for brevity... nothing special in the ViewHolder
</span><span style=color:#75715e></span>
  <span style=color:#75715e>/**
</span><span style=color:#75715e>   * Create new adapter and pass the diff callback to parent
</span><span style=color:#75715e>   */</span>
  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MovieAdapter</span><span style=color:#f92672>(</span>
      <span style=color:#a6e22e>@NonNull</span> DiffUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>ItemCallback</span><span style=color:#f92672>&lt;</span>Movie<span style=color:#f92672>&gt;</span> diffCallback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>diffCallback<span style=color:#f92672>);</span>
  <span style=color:#f92672>}</span>

  <span style=color:#75715e>// ... then the usual create(...) and bind(...) view holder methods
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</code></pre></div><p>Next we need to create a <a href=https://developer.android.com/reference/android/arch/paging/DataSource><code>DataSource</code></a> that will <em>connect</em> with the API and fetch data! There are 3 types of <code>DataSource</code> provided by the Paging Library:</p><ul><li><p><a href=https://developer.android.com/reference/android/arch/paging/ItemKeyedDataSource><code>ItemKeyedDataSource&lt;Key, Value></code></a>: Use it if you need to use data from item <code>N-1</code> to load item <code>N</code></p></li><li><p><a href=https://developer.android.com/reference/android/arch/paging/PageKeyedDataSource><code>PageKeyedDataSource&lt;Key, Value></code></a>: Use it if pages you load embed keys for loading adjacent pages.</p></li><li><p><a href=https://developer.android.com/reference/android/arch/paging/PositionalDataSource><code>PositionalDataSource&lt;T></code></a>: Use it if you can load pages of a requested size at arbitrary positions, and provide a fixed item count.</p></li></ul><p>You can read more about the types of <code>DataSource</code> and when to use which one on <a href=https://developer.android.com/reference/android/arch/paging/DataSource><code>DataSource</code> documentation</a></p><p>For our example, we will use <a href=https://developer.android.com/reference/android/arch/paging/PageKeyedDataSource><code>PageKeyedDataSource&lt;Key, Value></code></a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// required imports
</span><span style=color:#75715e></span><span style=color:#f92672>import</span> android.arch.paging.PageKeyedDataSource<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MoviesDataSource</span> 
  <span style=color:#66d9ef>extends</span> PageKeyedDataSource<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>,</span> Movie<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
    <span style=color:#75715e>// constant max retry count, see Bonus section for more!
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> MAX_RETRY <span style=color:#f92672>=</span> 3<span style=color:#f92672>;</span>
    <span style=color:#75715e>// retrofit service instance
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Tmdb<span style=color:#f92672>.</span><span style=color:#a6e22e>Api</span> tmdbApi<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MoviesDataSource</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Tmdb<span style=color:#f92672>.</span><span style=color:#a6e22e>Api</span> tmdbApi<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tmdbApi</span> <span style=color:#f92672>=</span> tmdbApi<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
    
    <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loadInitial</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> LoadInitialParams<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> params<span style=color:#f92672>,</span>
      <span style=color:#a6e22e>@NonNull</span> LoadInitialCallback<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>,</span> Movie<span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>

    <span style=color:#75715e>// load the first page
</span><span style=color:#75715e></span>    tmdbApi<span style=color:#f92672>.</span><span style=color:#a6e22e>getPopularMovies</span><span style=color:#f92672>(</span>1 <span style=color:#75715e>/* page */</span><span style=color:#f92672>).</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> CallbackWithRetry<span style=color:#f92672>&lt;</span>MovieResponse<span style=color:#f92672>&gt;(</span>MAX_RETRY<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>MovieResponse<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Response<span style=color:#f92672>&lt;</span>MovieResponse<span style=color:#f92672>&gt;</span> response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>isSuccessful</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
          MovieResponse movieResponse <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>();</span>

          <span style=color:#75715e>// send response back
</span><span style=color:#75715e></span>          callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResult</span><span style=color:#f92672>(</span>movieResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>getMovies</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#75715e>// null because there is no page before this
</span><span style=color:#75715e></span>              movieResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>getPage</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> 1<span style=color:#f92672>);</span> <span style=color:#75715e>// TMDb follows incrementing integer as pages numbers
</span><span style=color:#75715e></span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
          onFailure<span style=color:#f92672>(</span>call<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Exception<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unknown error&#34;</span><span style=color:#f92672>));</span>
        <span style=color:#f92672>}</span>
      <span style=color:#f92672>}</span>

      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFinalFailure</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>MovieResponse<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResult</span><span style=color:#f92672>(</span>Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>emptyList</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
      <span style=color:#f92672>}</span>
    <span style=color:#f92672>});</span>
  <span style=color:#f92672>}</span>

  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loadBefore</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> LoadParams<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> params<span style=color:#f92672>,</span>
      <span style=color:#a6e22e>@NonNull</span> LoadCallback<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>,</span> Movie<span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>

    <span style=color:#75715e>// params.key contains the page number of the page to load
</span><span style=color:#75715e></span>    tmdbApi<span style=color:#f92672>.</span><span style=color:#a6e22e>getPopularMovies</span><span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>).</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> CallbackWithRetry<span style=color:#f92672>&lt;</span>MovieResponse<span style=color:#f92672>&gt;(</span>MAX_RETRY<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>MovieResponse<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Response<span style=color:#f92672>&lt;</span>MovieResponse<span style=color:#f92672>&gt;</span> response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>isSuccessful</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
          MovieResponse movieResponse <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>();</span>
          <span style=color:#75715e>// return response, since we are moving backward adjacent page is - 1 from current position
</span><span style=color:#75715e></span>          callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResult</span><span style=color:#f92672>(</span>movieResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>getMovies</span><span style=color:#f92672>(),</span> movieResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>getPage</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
          onFailure<span style=color:#f92672>(</span>call<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Exception<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unknown error&#34;</span><span style=color:#f92672>));</span>
        <span style=color:#f92672>}</span>
      <span style=color:#f92672>}</span>

      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFinalFailure</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>MovieResponse<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResult</span><span style=color:#f92672>(</span>Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>emptyList</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
      <span style=color:#f92672>}</span>
    <span style=color:#f92672>});</span>
  <span style=color:#f92672>}</span>

  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loadAfter</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> LoadParams<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> params<span style=color:#f92672>,</span>
      <span style=color:#a6e22e>@NonNull</span> LoadCallback<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>,</span> Movie<span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    
    <span style=color:#75715e>// params.key contains the page number of the page to load
</span><span style=color:#75715e></span>    tmdbApi<span style=color:#f92672>.</span><span style=color:#a6e22e>getPopularMovies</span><span style=color:#f92672>(</span>params<span style=color:#f92672>.</span><span style=color:#a6e22e>key</span><span style=color:#f92672>).</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> CallbackWithRetry<span style=color:#f92672>&lt;</span>MovieResponse<span style=color:#f92672>&gt;(</span>MAX_RETRY<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onResponse</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>MovieResponse<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Response<span style=color:#f92672>&lt;</span>MovieResponse<span style=color:#f92672>&gt;</span> response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>isSuccessful</span><span style=color:#f92672>()){</span>
          MovieResponse movieResponse <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>();</span>
          <span style=color:#75715e>// return response, since we are moving forward adjacent page is + 1 from current position
</span><span style=color:#75715e></span>          callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResult</span><span style=color:#f92672>(</span>movieResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>getMovies</span><span style=color:#f92672>(),</span> movieResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>getPage</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> 1<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
          onFailure<span style=color:#f92672>(</span>call<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Exception<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unknown error&#34;</span><span style=color:#f92672>));</span>
        <span style=color:#f92672>}</span>
      <span style=color:#f92672>}</span>

      <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFinalFailure</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>MovieResponse<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        callback<span style=color:#f92672>.</span><span style=color:#a6e22e>onResult</span><span style=color:#f92672>(</span>Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>emptyList</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
      <span style=color:#f92672>}</span>
    <span style=color:#f92672>});</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>The only thing that remains for us is to connect our <code>MovieAdapter</code> with our <code>MovieDataSource</code> using a <a href=https://developer.android.com/reference/android/arch/paging/PagedList><code>PagedList</code></a>.</p><p>To use a <code>PagedList</code>, we first create a <a href=https://developer.android.com/reference/android/arch/paging/PagedList.Config><code>PagedList.Config</code></a>. We also need to create two <a href=https://developer.android.com/reference/java/util/concurrent/Executor><code>Executor</code></a> which will be used to <em>execute</em> fetch and notification calls from the <code>PagedList</code>, i.e., data fetching via <code>DataSource</code> will execute on the <em>fetch executor</em> and load- and boundary- callbacks will be executed by the <em>notify executor</em>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.Executor<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>

<span style=color:#75715e>// Ui thread executor to execute runnable on UI thread
</span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UiThreadExecutor</span> <span style=color:#66d9ef>implements</span> Executor <span style=color:#f92672>{</span>
  <span style=color:#66d9ef>private</span> Handler handler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Handler<span style=color:#f92672>(</span>Looper<span style=color:#f92672>.</span><span style=color:#a6e22e>getMainLooper</span><span style=color:#f92672>());</span>
  
  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Runnable command<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    handler<span style=color:#f92672>.</span><span style=color:#a6e22e>post</span><span style=color:#f92672>(</span>command<span style=color:#f92672>);</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

<span style=color:#75715e>// Background thread executor to execute runnable on background thread
</span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BackgroundThreadExecutor</span> <span style=color:#66d9ef>implements</span> Executor <span style=color:#f92672>{</span>
  <span style=color:#66d9ef>private</span> ExecutorService executorService <span style=color:#f92672>=</span> 
        Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newFixedThreadPool</span><span style=color:#f92672>(</span>2<span style=color:#f92672>);</span>
  
  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> Runnable command<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>command<span style=color:#f92672>);</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Then in your <code>Activity</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onCreate</span><span style=color:#f92672>(</span>Bundle savedInstanceState<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
  <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onCreate</span><span style=color:#f92672>(</span>savedInstanceState<span style=color:#f92672>);</span>

  <span style=color:#75715e>// usual onCreate code...
</span><span style=color:#75715e></span>
  <span style=color:#75715e>// setup recycler view
</span><span style=color:#75715e></span>  RecyclerView recycler <span style=color:#f92672>=</span> findViewById<span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>.</span><span style=color:#a6e22e>movies</span><span style=color:#f92672>);</span>
  recycler<span style=color:#f92672>.</span><span style=color:#a6e22e>setLayoutManager</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> GridLayoutManager<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> 2<span style=color:#f92672>));</span>
  <span style=color:#75715e>// create new movie adapter
</span><span style=color:#75715e></span>  MovieAdapter adapter <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MovieAdapter<span style=color:#f92672>(</span>Movie<span style=color:#f92672>.</span><span style=color:#a6e22e>DIFF_CALLBACK</span><span style=color:#f92672>);</span>
  <span style=color:#75715e>// add adapter to recyclerview
</span><span style=color:#75715e></span>  recycler<span style=color:#f92672>.</span><span style=color:#a6e22e>setAdapter</span><span style=color:#f92672>(</span>adapter<span style=color:#f92672>);</span>
  
  <span style=color:#75715e>// create data source
</span><span style=color:#75715e></span>  MoviesDataSource dataSource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MoviesDataSource<span style=color:#f92672>(</span>getRetofitApi<span style=color:#f92672>());</span>
  <span style=color:#75715e>// create configuration
</span><span style=color:#75715e></span>  <span style=color:#75715e>// see https://is.gd/l4hv42
</span><span style=color:#75715e></span>  PagedList<span style=color:#f92672>.</span><span style=color:#a6e22e>Config</span> config <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PagedList<span style=color:#f92672>.</span><span style=color:#a6e22e>Config</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>()</span>
      <span style=color:#75715e>// this is not used by TMDb as we cannot pass page size to API
</span><span style=color:#75715e></span>      <span style=color:#75715e>// but is required by PagedList to use as hint
</span><span style=color:#75715e></span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>setPageSize</span><span style=color:#f92672>(</span>10<span style=color:#f92672>)</span>
      <span style=color:#f92672>.</span><span style=color:#a6e22e>setPrefetchDistance</span><span style=color:#f92672>(</span>5<span style=color:#f92672>)</span>
      <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
  <span style=color:#75715e>// create paged list
</span><span style=color:#75715e></span>  PagedList<span style=color:#f92672>&lt;</span>Movie<span style=color:#f92672>&gt;</span> pagedList <span style=color:#f92672>=</span> 
    <span style=color:#66d9ef>new</span> PagedList<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span><span style=color:#f92672>&lt;&gt;(</span>dataSource<span style=color:#f92672>,</span> config<span style=color:#f92672>)</span>
      <span style=color:#75715e>// get list notifications on Ui thread
</span><span style=color:#75715e></span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>setNotifyExecutor</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> UiThreadExecutor<span style=color:#f92672>())</span>
      <span style=color:#75715e>// execute fetches on a background thread
</span><span style=color:#75715e></span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>setFetchExecutor</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> BackgroundThreadExecutor<span style=color:#f92672>())</span>
      <span style=color:#75715e>// build!
</span><span style=color:#75715e></span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
  <span style=color:#75715e>// update adapter&#39;s paged list (and data source)
</span><span style=color:#75715e></span>  adapter<span style=color:#f92672>.</span><span style=color:#a6e22e>submitList</span><span style=color:#f92672>(</span>pagedList<span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>That&rsquo;s it! In a (sort of) few lines of code (if we remove the inherent verbosity in Java), we get a <code>RecyclerView.Adapter</code> that is capable of <em>efficiently</em> loading data and presenting it on the UI all while keeping it <em>low</em> on resources and preventing janky UI!</p><h3 id=bonus>Bonus!<a href=#bonus class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Here is the source of the <code>retrofit2.Callback&lt;T></code> with <em>exponential backoff</em> retry policy, i.e., it will retry the request each time on failure with exponentially increasing delay to prevent network and API abuse!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// retrofit callback implementation with retry policy
</span><span style=color:#75715e>// adapted from https://stackoverflow.com/a/41884400/6611700
</span><span style=color:#75715e>// adapted from https://is.gd/KaEwPt (exponential delay)
</span><span style=color:#75715e></span><span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CallbackWithRetry</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> retrofit2<span style=color:#f92672>.</span><span style=color:#a6e22e>Callback</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
  <span style=color:#75715e>// exponential backoff delay
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> RETRY_DELAY <span style=color:#f92672>=</span> 300<span style=color:#f92672>;</span> <span style=color:#75715e>/* ms */</span>
  
  <span style=color:#75715e>// max allowed retries
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> maxAttempts<span style=color:#f92672>;</span>
  <span style=color:#75715e>// current attempts
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> attempts <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>

  CallbackWithRetry<span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> max<span style=color:#f92672>){</span>
    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>maxAttempts</span> <span style=color:#f92672>=</span> max<span style=color:#f92672>;</span>
  <span style=color:#f92672>}</span>
  
  <span style=color:#a6e22e>@Override</span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFailure</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    attempts<span style=color:#f92672>++;</span>
    <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>attempts <span style=color:#f92672>&lt;</span> maxAttempts<span style=color:#f92672>){</span>
      <span style=color:#66d9ef>int</span> delay <span style=color:#f92672>=</span> 
          <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>)</span> <span style=color:#f92672>(</span>RETRY_DELAY <span style=color:#f92672>*</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>pow</span><span style=color:#f92672>(</span>2<span style=color:#f92672>,</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>max</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> attempts <span style=color:#f92672>-</span> 1<span style=color:#f92672>)));</span>
      <span style=color:#66d9ef>new</span> Handler<span style=color:#f92672>().</span><span style=color:#a6e22e>postDelayed</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> retry<span style=color:#f92672>(</span>call<span style=color:#f92672>),</span> delay<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
      onFinalFailure<span style=color:#f92672>(</span>call<span style=color:#f92672>,</span> t<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>}</span>
  
  <span style=color:#75715e>// failure hook called when retries are consumed
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onFinalFailure</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>,</span> Throwable t<span style=color:#f92672>);</span>
  
  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>retry</span><span style=color:#f92672>(</span>Call<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> call<span style=color:#f92672>){</span>
    call<span style=color:#f92672>.</span><span style=color:#a6e22e>clone</span><span style=color:#f92672>().</span><span style=color:#a6e22e>enqueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Hope you enjoyed the post! If you&rsquo;ve any doubts regarding any of the stuff here feel free to <a href=https://github.com/riyaz-ali/riyaz-ali.github.io/issues/new>open an issue on GitHub</a>{:target="_blank"} and I&rsquo;ll try my best to explain it! Till then goodbye!</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://riyazali.net/posts/google-image-proxy/><span class=button__icon>←</span>
<span class=button__text>Google Image Proxy</span></a></span>
<span class="button next"><a href=https://riyazali.net/posts/discourse-login-on-android/><span class=button__text>Discourse Login on Android</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>© Riyaz Ali</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://riyazali.net/assets/main.js></script><script src=https://riyazali.net/assets/prism.js></script><div class=license><div>Unless stated, contents of this site are licensed under <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>CreativeCommons BY-SA 4.0</a></div><div>Source snippets licensed under <a rel=license href=https://opensource.org/licenses/MIT>MIT © Riyaz Ali 2024</a></div><div style=margin-top:16px><a href=https://twitter.com/riyaz2302 style=text-decoration:none><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" style="fill:#fff" viewBox="0 0 24 24"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179.0-5.515 2.966-4.797 6.045C7.728 8.088 4.1 6.128 1.671 3.149c-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142.0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg></a><span style=padding-left:8px></span><a href=https://github.com/riyaz-ali style=text-decoration:none><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" style="fill:#fff"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg></a></div></div></div></body></html>